(.venv) a847848@MACH9XRKY9W9F Aplication_Insights % python3 exp1.py     
/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/urllib3/__init__.py:35: NotOpenSSLWarning: urllib3 v2 only supports OpenSSL 1.1.1+, currently the 'ssl' module is compiled with 'LibreSSL 2.8.3'. See: https://github.com/urllib3/urllib3/issues/3020
  warnings.warn(
Datetime with no tzinfo will be considered UTC.
Datetime with no tzinfo will be considered UTC.
DefaultAzureCredential failed to retrieve a token from the included credentials.
Attempted credentials:
        EnvironmentCredential: EnvironmentCredential authentication unavailable. Environment variables are not fully configured.
Visit https://aka.ms/azsdk/python/identity/environmentcredential/troubleshoot to troubleshoot this issue.
        ManagedIdentityCredential: Unexpected content type "text/html"
Content: <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<!-- FileName: index.html
     Language: [en]
-->
<!--Head-->
<head>
<!--
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
-->
<meta content="text/html" http-equiv="Content-Type" />
  <meta http-equiv="X-UA-Compatible" content="IE=7" />
  <title>McAfee Web Gateway - Notification</title>
  <script src="/mwg-internal/de5fs23hu73ds/files/javascript/sw.js" type="text/javascript" ></script>
 <script src="/mwg-internal/de5fs23hu73ds/files/default/geolocation.js" type="text/javascript" ></script>
  <link rel="stylesheet" href="/mwg-internal/de5fs23hu73ds/files/default/stylesheet.css" />
</head>
<!--/Head-->
<!--Body-->
<body onload="swOnLoad();">
  <table class='bodyTable'>
    <tr>
      <td class='bodyData' background='/mwg-internal/de5fs23hu73ds/files/default/img/bg_body.gif'>
<!--Logo-->
<table class='logoTable'>
  <tr>
    <td class='logoData' background='/mwg-internal/de5fs23hu73ds/files/default/img/bg_navbar.jpg'>
        <img src='/mwg-internal/de5fs23hu73ds/files/default/img/CVS_Health_logo_h_reg_rgb_wht2.png' HEIGHT="25" WIDTH="209" BORDER="0" />
    </td>
  </tr>
</table>
<!--/Logo-->
<!--Contents-->
<!-- FileName: authenticationrequired.html
     Language: [en]
-->
<!--Title-->
<table class='titleTable' background='/mwg-internal/de5fs23hu73ds/files/default/img/bg_navbar.jpg'>
  <tr>
    <td class='titleData'>
      Authentication Required
    </td>
  </tr>
</table>
<!--/Title-->

<!--Content-->
<table class="contentTable">
  <tr>
    <td class="contentData">
      You must be authenticated to access this URL.
    </td>
  </tr>
</table>
    
<script language="javascript" type="text/javascript">
   urlprotocol = "http";
   statuscode=302;

   if(statuscode==401 && urlprotocol == "ftp"){
      document.write("<form name=\"ftpform\" method=\"get\" action=\"\">");
      document.write("<table class=\"contentData\">");
 
To mitigate this issue, please refer to the troubleshooting guidelines here at https://aka.ms/azsdk/python/identity/defaultazurecredential/troubleshoot.
Traceback (most recent call last):
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/monitor/query/_logs_query_client.py", line 135, in query_workspace
    generated_response = self._query_op.execute(  # pylint: disable=protected-access
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/tracing/decorator.py", line 78, in wrapper_use_tracer
    return func(*args, **kwargs)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/monitor/query/_generated/operations/_operations.py", line 692, in execute
    pipeline_response: PipelineResponse = self._client._pipeline.run(  # pylint: disable=protected-access
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/pipeline/_base.py", line 230, in run
    return first_node.send(pipeline_request)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/pipeline/_base.py", line 86, in send
    response = self.next.send(request)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/pipeline/_base.py", line 86, in send
    response = self.next.send(request)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/pipeline/_base.py", line 86, in send
    response = self.next.send(request)
  [Previous line repeated 2 more times]
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/pipeline/policies/_redirect.py", line 197, in send
    response = self.next.send(request)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/pipeline/policies/_retry.py", line 531, in send
    response = self.next.send(request)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/pipeline/policies/_authentication.py", line 124, in send
    self.on_request(request)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/pipeline/policies/_authentication.py", line 99, in on_request
    self._token = self._credential.get_token(*self._scopes)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/identity/_credentials/default.py", line 225, in get_token
    token = super().get_token(*scopes, claims=claims, tenant_id=tenant_id, **kwargs)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/identity/_credentials/chained.py", line 124, in get_token
    raise ClientAuthenticationError(message=message)
azure.core.exceptions.ClientAuthenticationError: DefaultAzureCredential failed to retrieve a token from the included credentials.
Attempted credentials:
        EnvironmentCredential: EnvironmentCredential authentication unavailable. Environment variables are not fully configured.
Visit https://aka.ms/azsdk/python/identity/environmentcredential/troubleshoot to troubleshoot this issue.
        ManagedIdentityCredential: Unexpected content type "text/html"
Content: <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<!-- FileName: index.html
     Language: [en]
-->
<!--Head-->
<head>
<!--
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
-->
<meta content="text/html" http-equiv="Content-Type" />
  <meta http-equiv="X-UA-Compatible" content="IE=7" />
  <title>McAfee Web Gateway - Notification</title>
  <script src="/mwg-internal/de5fs23hu73ds/files/javascript/sw.js" type="text/javascript" ></script>
 <script src="/mwg-internal/de5fs23hu73ds/files/default/geolocation.js" type="text/javascript" ></script>
  <link rel="stylesheet" href="/mwg-internal/de5fs23hu73ds/files/default/stylesheet.css" />
</head>
<!--/Head-->
<!--Body-->
<body onload="swOnLoad();">
  <table class='bodyTable'>
    <tr>
      <td class='bodyData' background='/mwg-internal/de5fs23hu73ds/files/default/img/bg_body.gif'>
<!--Logo-->
<table class='logoTable'>
  <tr>
    <td class='logoData' background='/mwg-internal/de5fs23hu73ds/files/default/img/bg_navbar.jpg'>
        <img src='/mwg-internal/de5fs23hu73ds/files/default/img/CVS_Health_logo_h_reg_rgb_wht2.png' HEIGHT="25" WIDTH="209" BORDER="0" />
    </td>
  </tr>
</table>
<!--/Logo-->
<!--Contents-->
<!-- FileName: authenticationrequired.html
     Language: [en]
-->
<!--Title-->
<table class='titleTable' background='/mwg-internal/de5fs23hu73ds/files/default/img/bg_navbar.jpg'>
  <tr>
    <td class='titleData'>
      Authentication Required
    </td>
  </tr>
</table>
<!--/Title-->

<!--Content-->
<table class="contentTable">
  <tr>
    <td class="contentData">
      You must be authenticated to access this URL.
    </td>
  </tr>
</table>
    
<script language="javascript" type="text/javascript">
   urlprotocol = "http";
   statuscode=302;

   if(statuscode==401 && urlprotocol == "ftp"){
      document.write("<form name=\"ftpform\" method=\"get\" action=\"\">");
      document.write("<table class=\"contentData\">");
 
To mitigate this issue, please refer to the troubleshooting guidelines here at https://aka.ms/azsdk/python/identity/defaultazurecredential/troubleshoot.

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/Aplication_Insights/exp1.py", line 27, in <module>
    response = client.query_workspace(
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/core/tracing/decorator.py", line 78, in wrapper_use_tracer
    return func(*args, **kwargs)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/monitor/query/_logs_query_client.py", line 139, in query_workspace
    process_error(err, LogsQueryError)
  File "/Users/a847848/Desktop/Python_Dev_AIHUB/.venv/lib/python3.9/site-packages/azure/monitor/query/_helpers.py", line 157, in process_error
    raise HttpResponseError(message=error.message, response=error.response, model=model)
azure.core.exceptions.HttpResponseError: DefaultAzureCredential failed to retrieve a token from the included credentials.
Attempted credentials:
        EnvironmentCredential: EnvironmentCredential authentication unavailable. Environment variables are not fully configured.
Visit https://aka.ms/azsdk/python/identity/environmentcredential/troubleshoot to troubleshoot this issue.
        ManagedIdentityCredential: Unexpected content type "text/html"
Content: <!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<!-- FileName: index.html
     Language: [en]
-->
<!--Head-->
<head>
<!--
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
-->
<meta content="text/html" http-equiv="Content-Type" />
  <meta http-equiv="X-UA-Compatible" content="IE=7" />
  <title>McAfee Web Gateway - Notification</title>
  <script src="/mwg-internal/de5fs23hu73ds/files/javascript/sw.js" type="text/javascript" ></script>
 <script src="/mwg-internal/de5fs23hu73ds/files/default/geolocation.js" type="text/javascript" ></script>
  <link rel="stylesheet" href="/mwg-internal/de5fs23hu73ds/files/default/stylesheet.css" />
</head>
<!--/Head-->
<!--Body-->
<body onload="swOnLoad();">
  <table class='bodyTable'>
    <tr>
      <td class='bodyData' background='/mwg-internal/de5fs23hu73ds/files/default/img/bg_body.gif'>
<!--Logo-->
<table class='logoTable'>
  <tr>
    <td class='logoData' background='/mwg-internal/de5fs23hu73ds/files/default/img/bg_navbar.jpg'>
        <img src='/mwg-internal/de5fs23hu73ds/files/default/img/CVS_Health_logo_h_reg_rgb_wht2.png' HEIGHT="25" WIDTH="209" BORDER="0" />
    </td>
  </tr>
</table>
<!--/Logo-->
<!--Contents-->
<!-- FileName: authenticationrequired.html
     Language: [en]
-->
<!--Title-->
<table class='titleTable' background='/mwg-internal/de5fs23hu73ds/files/default/img/bg_navbar.jpg'>
  <tr>
    <td class='titleData'>
      Authentication Required
    </td>
  </tr>
</table>
<!--/Title-->

<!--Content-->
<table class="contentTable">
  <tr>
    <td class="contentData">
      You must be authenticated to access this URL.
    </td>
  </tr>
</table>
    
<script language="javascript" type="text/javascript">
   urlprotocol = "http";
   statuscode=302;

   if(statuscode==401 && urlprotocol == "ftp"){
      document.write("<form name=\"ftpform\" method=\"get\" action=\"\">");
      document.write("<table class=\"contentData\">");
 
To mitigate this issue, please refer to the troubleshooting guidelines here at https://aka.ms/azsdk/python/identity/defaultazurecredential/troubleshoot.


from azure.identity import DefaultAzureCredential
from azure.monitor.query import LogsQueryClient
from datetime import datetime

# Initialize the client
credential = DefaultAzureCredential()
client = LogsQueryClient(credential)

# Define your Application Insights workspace ID
workspace_id = "YOUR_WORKSPACE_ID"

# Define the Kusto query to get the request count, including a filter for the subscription name
subscription_name = "YOUR_SUBSCRIPTION_NAME"
query = f"""
requests
| where timestamp >= datetime(2024-05-01) and timestamp < datetime(2024-06-01)
| where client_SubscriptionName == '{subscription_name}'
| summarize total_requests = count()
"""

# Define the time range for the query
start_time = datetime(2024, 5, 1)
end_time = datetime(2024, 5, 31)

# Execute the query
response = client.query_workspace(
    workspace_id=workspace_id,
    query=query,
    timespan=(start_time, end_time)
)

# Extract and print the request count
if response.status == 'Success':
    for table in response.tables:
        for row in table.rows:
            print(f"Total Requests: {row[0]}")
else:
    print(f"Query failed with status: {response.status}")





-----------

To automate fetching application insights data from Azure and present it in a Streamlit dashboard or another type of visualization, you can follow these general steps:

Set Up Azure SDK: First, you'll need to set up Azure SDK for Python in your development environment. This includes installing necessary packages and configuring authentication to interact with Azure resources.

Authenticate with Azure: Utilize Azure Identity client library to authenticate against Azure. This involves setting up a service principal or using managed identity if running in Azure, which allows your application to access resources.

Fetch Data from Application Insights: Use the Azure Monitor Query client library to execute queries against Application Insights. You'll construct Kusto Query Language (KQL) queries to fetch the required data based on filters like date ranges.

Data Processing: Process the data retrieved from Application Insights to format it according to your needs (e.g., aggregating transactions by client name and API version).

Integration with Streamlit: Develop a Streamlit application to display the processed data. This involves designing the UI and setting up interactive elements if needed.

Automation: Automate the process by scripting the data fetching and processing steps to run on a schedule or trigger.

Step-by-Step Implementation
1. Install Required Libraries
You can install these libraries via pip in your VS Code terminal:

bash
Copy code
pip install azure-identity azure-monitor-query streamlit
2. Authenticate and Fetch Data
Here's a Python script example to authenticate and query Application Insights:

python
Copy code
from azure.identity import DefaultAzureCredential
from azure.monitor.query import LogsQueryClient, LogsQueryStatus
import pandas as pd

credential = DefaultAzureCredential()

client = LogsQueryClient(credential)

# Adjust the timespan to your needs
timespan = "2023-04-01/2023-04-30"

# Sample KQL query, customize it based on your specific data structure
kql = """
AppRequests
| where TimeGenerated >= datetime(2023-04-01) and TimeGenerated < datetime(2023-05-01)
| summarize Count=count() by Client_Name, Api_Version
| extend Percentage = round(100.0 * Count / sum(Count) over(), 1)
"""

response = client.query_workspace('your-workspace-id', kql, timespan)

if response.status == LogsQueryStatus.SUCCESS:
    df = pd.DataFrame([dict(row) for row in response.tables[0].rows], columns=[col.name for col in response.tables[0].columns])
    print(df)
else:
    print("Query failed:", response.partial_error)

3. Streamlit Dashboard
Set up a simple Streamlit dashboard:

python
Copy code
import streamlit as st

# Assuming 'df' is the DataFrame obtained from the query
st.title('API Transactions Insights')
st.dataframe(df)  # Display the DataFrame as a table in Streamlit
Run your Streamlit app by typing streamlit run your_script.py in your terminal.

4. Automation
Consider automating this script to run periodically using cron jobs or workflow automation tools like GitHub Actions, depending on where the code resides.
